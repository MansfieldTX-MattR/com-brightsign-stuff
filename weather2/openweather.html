<!DOCTYPE html>
<html>
    <head>
        <link id="weather-data-url" href="/weather-data-json">
        <link rel="stylesheet" href="/static/weather2/open-weather-icons/css/open-weather-icons.css">
        <style>
            #sky{
                position: fixed;
                left: 0;
                top: 0;
                z-index: -1;
            }
            .current{
                text-align: center;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 2em;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 1em;
                margin-top: 5rem;
                margin-left: 5%;
                margin-right: 5%;
                color: white;
                background-color: rgba(0,0,0,.2);
            }
            .current > *{
                padding-top: 1rem;
                padding-bottom: 1rem;
            }
            .temperature{
                font-size: 3.5em;
            }
            .condition{
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: space-around;
                width: 50%;
            }
            .condition > p{

            }
            .condition > img{
                max-width: 7em;
            }
            #info{
                display: none;
            }
        </style>
    </head>
    <body>
        <canvas id="sky"></canvas>
        <main>
            <div class="current">
                <div class="temperature">{{ weather_data.main.temp }}°F</div>
                {% for w in weather_data.weather %}
                <div class="condition">
                    <img src="{{ w.meteocon }}" loading="lazy">
                    <p>({{ w.description }})</p>
                </div>
                {% endfor %}
            </div>
        </main>
        <div id="info"></div>

        <script src="//unpkg.com/suncalc@1.8.0/suncalc.js"></script>

        <!-- Import maps polyfill -->
        <!-- Remove this when import maps will be widely supported -->
        <script async src="//unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

        <script type="importmap">
            {
                "imports": {
                "three": "//unpkg.com/three@0.152.2/build/three.module.js",
                "three/addons/": "//unpkg.com/three@0.152.2/examples/jsm/"
                }
            }
        </script>

        <script type="module" src="/static/weather2/skysim.js"></script>
        <script id="weather-json" type="application/json">{{ weather_data|tojson(2) }}</script>
        <script type="text/javascript">
            async function fetchWeather(){
                const url = document.getElementById('weather-data-url').href;
                const resp = await fetch(url);
                return await resp.json();
            }
            async function updateWeather(){
                if (window.stopWeather){
                    return;
                }
                const scriptEl = document.getElementById('weather-json');
                const currentData = JSON.parse(scriptEl.textContent);
                const weatherData = await fetchWeather();
                if (currentData.dt === weatherData.dt){
                    console.log('dts match');
                    return;
                }
                console.log('updating stuff: ', weatherData);
                scriptEl.textContent = JSON.stringify(weatherData);

                const currentDiv = document.querySelector("main > .current");
                currentDiv.querySelector(".temperature").textContent = `${weatherData.main.temp}°F`;
                currentDiv.querySelectorAll(".condition").forEach((el) => {
                    el.remove();
                });
                weatherData.weather.forEach((w) => {
                    const rootDiv = document.createElement('div');
                    rootDiv.classList.add('condition');
                    const img = document.createElement('img');
                    img.src = w.meteocon;
                    img.loading = "lazy";
                    rootDiv.appendChild(img);
                    const p = document.createElement('p');
                    p.textContent = `(${w.description})`;
                    rootDiv.appendChild(p);
                    currentDiv.appendChild(rootDiv);
                });
            }

            function fetchAndUpdate(){
                if (window.stopWeather){
                    return;
                }
                updateWeather().then(window.setTimeout(fetchAndUpdate, 10000));
            }

            window.setTimeout(fetchAndUpdate, 10000);
        </script>
    </body>
</html>
