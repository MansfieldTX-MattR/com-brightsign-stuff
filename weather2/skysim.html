<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - shaders - sky sun shader</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
            body {
                margin: 0;
                background-color: #000;
                color: #fff;
                font-family: Monospace;
                font-size: 13px;
                line-height: 24px;
                overscroll-behavior: none;
            }

            a {
                color: #ff0;
                text-decoration: none;
            }

            a:hover {
                text-decoration: underline;
            }

            button {
                cursor: pointer;
                text-transform: uppercase;
            }

            #info {
                position: absolute;
                top: 0px;
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
                text-align: center;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
                user-select: none;
                pointer-events: none;
                z-index: 1; /* TODO Solve this in HTML */
            }

            a, button, input, select {
                pointer-events: auto;
            }

            .lil-gui {
                z-index: 2 !important; /* TODO Solve this in HTML */
            }

            @media all and ( max-width: 640px ) {
                .lil-gui.root {
                    right: auto;
                    top: auto;
                    max-height: 50%;
                    max-width: 80%;
                    bottom: 0;
                    left: 0;
                }
            }

            #overlay {
                position: absolute;
                font-size: 16px;
                z-index: 2;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                background: rgba(0,0,0,0.7);
            }

                #overlay button {
                    background: transparent;
                    border: 0;
                    border: 1px solid rgb(255, 255, 255);
                    border-radius: 4px;
                    color: #ffffff;
                    padding: 12px 18px;
                    text-transform: uppercase;
                    cursor: pointer;
                }

            #notSupported {
                width: 50%;
                margin: auto;
                background-color: #f00;
                margin-top: 20px;
                padding: 10px;
            }
        </style>
	</head>
	<body>

		<div id="info"><a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - sky + sun shader
		</div>

        <script src="//unpkg.com/suncalc@1.8.0/suncalc.js"></script>
		<!-- Import maps polyfill -->
		<!-- Remove this when import maps will be widely supported -->
		<script async src="//unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

		<script type="importmap">
            {
              "imports": {
                "three": "//unpkg.com/three@0.152.2/build/three.module.js",
                "three/addons/": "//unpkg.com/three@0.152.2/examples/jsm/"
              }
            }
          </script>

		<script type="module">

			import * as THREE from 'three';

			import { GUI } from 'three/addons/libs/lil-gui.module.min.js';
			import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
			import { Sky } from 'three/addons/objects/Sky.js';


			let camera, scene, renderer;

			let sky, sun;

            const lat = 32.5773;
            const lon = -97.1416;
            const pi = Math.PI;

            function getSunPos(dt){
                const data = SunCalc.getPosition(dt, lat, lon);
                return {
                    elevation: THREE.MathUtils.radToDeg(data.altitude),// data.altitude * (180/pi),
                    azimuth: THREE.MathUtils.radToDeg(data.azimuth),// data.azimuth * (180/pi),
                };
            }


			init();
			render();




			function initSky() {

				// Add Sky
				sky = new Sky();
				sky.scale.setScalar( 450000 );
				scene.add( sky );

				sun = new THREE.Vector3();

				/// GUI
                const effectControls = {};

				const effectController = {
					turbidity: 10,
					rayleigh: 3,
					mieCoefficient: 0.005,
					mieDirectionalG: 0.7,
					elevation: 2,
					azimuth: 180,
					exposure: renderer.toneMappingExposure,
                    hour: 0,
                    minute: 0,
                    totalMinutes: 0,
                    dt: new Date(),
				};

                effectController.hour = effectController.dt.getHours();
                effectController.minute = effectController.dt.getMinutes();
                effectController.totalMinutes = effectController.hour * 60 + effectController.minute;


                function trackCamera(){
                    if (!camera){
                        return;
                    }
                    //const angleTo = camera.position.angleTo(sun);
                    //console.log(angleTo);
                    //camera.lookAt(sun);
                    const x = pi / 2;// THREE.MathUtils.degToRad(effectController.elevation + 90);
                    const z = THREE.MathUtils.degToRad(effectController.azimuth);
                    const eu = new THREE.Euler(x, 0, -z);
                    camera.setRotationFromEuler(eu);
                    //camera.rotateY(-z)
                    console.log(camera.rotation);
                }



				function guiChanged() {

					const uniforms = sky.material.uniforms;
					uniforms[ 'turbidity' ].value = effectController.turbidity;
					uniforms[ 'rayleigh' ].value = effectController.rayleigh;
					uniforms[ 'mieCoefficient' ].value = effectController.mieCoefficient;
					uniforms[ 'mieDirectionalG' ].value = effectController.mieDirectionalG;

					const phi = THREE.MathUtils.degToRad( 90 - effectController.elevation );
					const theta = THREE.MathUtils.degToRad( effectController.azimuth );

					sun.setFromSphericalCoords( 1, phi, theta );

					uniforms[ 'sunPosition' ].value.copy( sun );
                    trackCamera();

					renderer.toneMappingExposure = effectController.exposure;
					renderer.render( scene, camera );

				}

                function updateSunPos(){
                    //effectController.dt.setHours(effectController.hour);
                    //console.log(effectController.dt.getHours());
                    const sunPos = getSunPos(effectController.dt);
                    console.log(sunPos);
                    effectController.elevation = sunPos.elevation;
                    effectController.azimuth = sunPos.azimuth;
                    if (effectControls.elevation === undefined){

                    } else {
                        //effectControls.elevation.setValue(sunPos.elevation);
                        //effectControls.azimuth.setValue(sunPos.azimuth);
                        effectControls.elevation.updateDisplay();
                        effectControls.azimuth.updateDisplay();
                        guiChanged();
                    }
                }

                updateSunPos();



				const gui = new GUI();



				gui.add( effectController, 'turbidity', 0.0, 20.0, 0.1 ).onChange( guiChanged );
				gui.add( effectController, 'rayleigh', 0.0, 4, 0.001 ).onChange( guiChanged );
				gui.add( effectController, 'mieCoefficient', 0.0, 0.1, 0.001 ).onChange( guiChanged );
				gui.add( effectController, 'mieDirectionalG', 0.0, 1, 0.001 ).onChange( guiChanged );
				effectControls.elevation = gui.add( effectController, 'elevation', 0, 90, 0.1 );
				effectControls.azimuth = gui.add( effectController, 'azimuth', - 180, 180, 0.1 );
				gui.add( effectController, 'exposure', 0, 1, 0.0001 ).onChange( guiChanged );
                effectControls.hour = gui.add(effectController, 'hour', 0, 23, 1);
                effectControls.minute = gui.add(effectController, 'minute', 0, 60, 1);
                effectControls.totalMinutes = gui.add(effectController, 'totalMinutes', 0, 1440, 1);

                effectControls.elevation.onChange( guiChanged );
                effectControls.azimuth.onChange( guiChanged );

                window.gui = gui;
                window.effectController = effectController;
                window.effectControls = effectControls;

                effectControls.hour.onChange(function(){
                    effectController.dt.setHours(effectController.hour);
                    effectController.totalMinutes = effectController.hour * 60 + effectController.minute;
                    effectControls.totalMinutes.updateDisplay();
                    updateSunPos();
                });

                effectControls.minute.onChange(function(value){
                    effectController.dt.setMinutes(value);
                    effectController.totalMinutes = effectController.hour * 60 + effectController.minute;
                    effectControls.totalMinutes.updateDisplay();
                    updateSunPos();
                });

                effectControls.totalMinutes.onChange(function(value){
                    const h = Math.floor(value / 60);
                    const m = value % 60;
                    effectController.dt.setHours(h);
                    effectController.dt.setMinutes(m);
                    effectController.hour = h;
                    effectController.minute = m;
                    effectControls.hour.updateDisplay();
                    effectControls.minute.updateDisplay();
                    updateSunPos();
                });


                effectController.setNow = function(){
                    effectController.dt = new Date();
                    effectController.hour = effectController.dt.getHours();
                    effectController.minute = effectController.dt.getMinutes();
                    effectController.totalMinutes = effectController.hour * 60 + effectController.minute;
                    //effectControls.hour.setValue(effectController.dt.getHours());
                    effectControls.hour.updateDisplay();
                    effectControls.minute.updateDisplay();
                    effectControls.totalMinutes.updateDisplay();
                    updateSunPos();

                    //const now = new Date();
                    //const sunPos = getSunPos(now);
                    //console.log(sunPos);
                    //elevationControl.setValue(sunPos.elevation);
                    //azimuthControl.setValue(sunPos.azimuth);
                };

                gui.add( effectController, 'setNow');

				guiChanged();



			}

			function init() {

				camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 100, 2000000 );
				camera.position.set( 0, 100, 2000 );

				scene = new THREE.Scene();

				const helper = new THREE.GridHelper( 10000, 2, 0xffffff, 0xffffff );
				scene.add( helper );

				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.toneMapping = THREE.ACESFilmicToneMapping;
				renderer.toneMappingExposure = 0.5;
				document.body.appendChild( renderer.domElement );

				const controls = new OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', render );
				//controls.maxPolarAngle = Math.PI / 2;
				controls.enableZoom = false;
				controls.enablePan = false;

				initSky();

				window.addEventListener( 'resize', onWindowResize );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();

			}

			function render() {

				renderer.render( scene, camera );

			}

		</script>

	</body>

</html>